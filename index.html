<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridMaster: Print & Play Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --panel-color: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #333;
            --slice-guide-color: #0ff;
            --slice-dash-color: #fff;
            --slice-shadow: #000;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 340px;
            background-color: var(--panel-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 100;
            flex-shrink: 0;
        }

        .logo {
            padding: 20px;
            font-size: 20px; font-weight: bold; color: #fff;
            display: flex; align-items: center; gap: 8px;
            border-bottom: 1px solid #333;
        }
        .logo span { color: var(--accent-color); font-size: 24px; }

        .nav-tabs { display: flex; background: #111; }
        .nav-tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            background: #181818; color: #777; font-weight: 600;
            border-bottom: 2px solid transparent; transition: 0.2s;
        }
        .nav-tab:hover { color: #ccc; }
        .nav-tab.active {
            background: var(--panel-color);
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .sidebar-content {
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column;
            gap: 20px; flex: 1;
        }
        .sidebar-panel { display: none; flex-direction: column; gap: 20px; }
        .sidebar-panel.active { display: flex; }

        /* Controls */
        .control-group {
            display: flex; flex-direction: column; gap: 8px;
            background: #252525; padding: 12px; border-radius: 8px;
        }
        .control-header {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; color: #aaa;
        }
        .val-disp { color: var(--accent-color); font-weight: bold; }
        
        .control-row { display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; cursor: pointer; accent-color: var(--accent-color); }
        
        input[type="color"] {
            width: 32px; height: 32px; border: none; padding: 0;
            background: none; cursor: pointer; border-radius: 50%;
            overflow: hidden; flex-shrink: 0;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid #555; border-radius: 50%; }

        select {
            background-color: #333; color: white; border: 1px solid #444;
            padding: 6px; border-radius: 4px; flex: 1; font-size: 13px;
        }

        /* Buttons */
        .btn {
            background-color: var(--accent-color); color: white;
            border: none; padding: 12px; border-radius: 6px;
            cursor: pointer; font-weight: 600; font-size: 14px;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            transition: 0.2s; width: 100%;
        }
        .btn:hover { background-color: var(--accent-hover); }
        .btn:disabled { background-color: #444; cursor: not-allowed; opacity: 0.7; }
        .btn-green { background-color: #10b981; }
        .btn-green:hover { background-color: #059669; }
        .btn-outline { background: transparent; border: 1px solid #555; color: #ccc; }
        .btn-outline:hover { border-color: #fff; color: #fff; }
        .btn-reset { font-size: 12px; padding: 8px; color: #777; border: 1px dashed #444; margin-top: 10px; }
        .btn-reset:hover { color: #aaa; border-color: #666; }

        /* --- Main Area --- */
        .main-area {
            flex: 1;
            background-color: #0d0d0d;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden; 
            position: relative;
        }

        .drop-overlay {
            position: absolute; top:0; left:0; width: 100%; height: 100%;
            background: rgba(59, 130, 246, 0.15);
            border: 4px dashed var(--accent-color);
            z-index: 999;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        .drop-overlay.active { opacity: 1; }
        .drop-overlay h2 { color: var(--accent-color); background: #000; padding: 10px 20px; border-radius: 8px; }

        .view-container {
            width: 100%; height: 100%;
            overflow-y: auto;
            display: none;
            padding: 40px;
            align-items: flex-start; 
            justify-content: center;
        }
        .view-container.active { display: flex; }
        
        .view-content-wrapper {
            display: flex; flex-direction: column; align-items: center;
            width: 100%;
            transform-origin: top center;
            transition: transform 0.1s linear;
        }

        /* --- Slicer Styles --- */
        .slicer-stage {
            position: relative;
            box-shadow: 0 0 60px rgba(0,0,0,0.7);
            outline: 2px solid var(--slice-guide-color);
            max-width: 100%;
        }
        .source-img { display: block; max-width: 100%; height: auto; }
        .slicer-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: grid; pointer-events: none;
        }
        .slicer-cell {
            border: 2px dashed var(--slice-dash-color);
            box-shadow: inset 0 0 2px var(--slice-shadow), 0 0 2px var(--slice-shadow);
            z-index: 10;
        }

        /* --- Collage Styles --- */
        .sheet-card {
            background: var(--panel-color);
            padding: 10px 10px 45px 10px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            width: 1000px;
            flex-shrink: 0;
            border: 1px solid #333;
            margin-bottom: 40px;
        }
        .sheet-header {
            color: #ccc; font-size: 14px; margin-bottom: 10px; padding: 0 5px;
            display: flex; justify-content: space-between;
        }
        
        .sheet-frame {
            background-color: var(--pad-color, #ffffff);
            padding: var(--pad-px, 0px);
            width: 100%;
            transition: padding 0.1s, background-color 0.1s;
        }

        .sheet-grid {
            display: grid;
            background-color: var(--gap-color, #000000);
            min-height: 200px;
            width: 100%;
            
            /* GAP —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∏ –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏, –∏ –∫–∞–∫ –æ—Ç—Å—Ç—É–ø –ø–æ –∫—Ä–∞—è–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            gap: var(--native-gap, 0px);
            padding: var(--native-gap, 0px);
            
            transition: background-color 0.1s;
            overflow: hidden; 
        }

        .grid-wrapper {
            position: relative;
            width: 100%;
        }

        .grid-item {
            display: block; 
            width: 100%;
            height: auto; 
            object-fit: cover;
            position: relative;
            z-index: 2;
        }
        
        .guide-overlay {
            position: absolute;
            
            /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π —Ä–æ—Å—Ç –ª–∏–Ω–∏–π --- */
            /* –ú—ã —Å–¥–≤–∏–≥–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –æ–≤–µ—Ä–ª–µ—è –Ω–∞—Ä—É–∂—É –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω—É —Ç–æ–ª—â–∏–Ω—ã –ª–∏–Ω–∏–∏. */
            /* –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ª–∏–Ω–∏—è –≤—Å–µ–≥–¥–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≥—Ä–∞–Ω–∏—Ü—ã –∑–∞–∑–æ—Ä–∞. */
            
            top:    calc( (var(--native-gap, 0px) / -2) - (var(--guide-width-px, 1px) / 2) );
            left:   calc( (var(--native-gap, 0px) / -2) - (var(--guide-width-px, 1px) / 2) );
            right:  calc( (var(--native-gap, 0px) / -2) - (var(--guide-width-px, 1px) / 2) );
            bottom: calc( (var(--native-gap, 0px) / -2) - (var(--guide-width-px, 1px) / 2) );
            
            /* –¢–æ–ª—â–∏–Ω–∞ –≥—Ä–∞–Ω–∏—Ü—ã —Ç–µ–ø–µ—Ä—å —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π */
            border: var(--guide-width-px, 1px) var(--guide-style, none) var(--guide-color, #999);
            
            z-index: 1; 
            pointer-events: none;
        }

        .sheet-btn {
            position: absolute; bottom: 10px; right: 10px;
            background: #333; color: white; border: none; padding: 6px 14px;
            border-radius: 4px; font-size: 12px; cursor: pointer;
        }
        .sheet-btn:hover { background: #555; }

        .hidden { display: none !important; }
        .empty-msg { text-align: center; color: #555; margin-top: 100px; width: 100%; }
        .empty-msg h3 { font-size: 24px; margin-bottom: 10px; }
        #fileInputSource, #fileInputCollage { display: none; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><span>‚öî</span> GridMaster</div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('slicer')">‚úÇÔ∏è –†–∞–∑—Ä–µ–∑–∫–∞</div>
            <div class="nav-tab" onclick="switchTab('collage')">‚ñ¶ –ö–æ–ª–ª–∞–∂</div>
        </div>

        <div class="sidebar-content">
            
            <div id="panel-slicer" class="sidebar-panel active">
                <div class="control-group">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">–®–∞–≥ 1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å—Ö–æ–¥–Ω–∏–∫</div>
                    <button class="btn" onclick="document.getElementById('fileInputSource').click()">
                        üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                    </button>
                    <input type="file" id="fileInputSource" accept="image/*">
                </div>

                <div class="control-group">
                    <div class="control-header">
                        <span>–°–µ—Ç–∫–∞ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ (–®–∏—Ä–∏–Ω–∞)</span>
                        <span class="val-disp" id="sliceColVal">2</span>
                    </div>
                    <input type="range" id="sliceColRange" min="1" max="20" value="2">
                    
                    <div class="control-header" style="margin-top:10px;">
                        <span>–°–µ—Ç–∫–∞ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ (–í—ã—Å–æ—Ç–∞)</span>
                        <span class="val-disp" id="sliceRowVal">2</span>
                    </div>
                    <input type="range" id="sliceRowRange" min="1" max="20" value="2">
                </div>

                <div class="control-group">
                    <div class="control-header">
                        <span>–ú–∞—Å—à—Ç–∞–± –≤–∏–¥–∞</span>
                        <span class="val-disp" id="slicerScaleVal">100%</span>
                    </div>
                    <input type="range" id="slicerScaleRange" min="0.1" max="3.0" step="0.1" value="1.0">
                </div>

                <div style="margin-top:auto;">
                    <button class="btn btn-green" id="btnSlice" disabled onclick="processSlicing()">
                        ‚úÇ –†–∞–∑—Ä–µ–∑–∞—Ç—å –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –≤ –ö–æ–ª–ª–∞–∂
                    </button>
                    <button class="btn btn-outline btn-reset" onclick="resetSettings('slicer')">
                        ‚Üª –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>
            </div>

            <div id="panel-collage" class="sidebar-panel">
                <div class="control-group">
                    <div class="control-header">
                        <span>–ö–æ–ª–æ–Ω–∫–∏ (–®–∏—Ä–∏–Ω–∞)</span>
                        <span class="val-disp" id="colVal">3</span>
                    </div>
                    <input type="range" id="colRange" min="1" max="10" value="3">
                    
                    <div class="control-header" style="margin-top:10px;">
                        <span>–°—Ç—Ä–æ–∫–∏ (–í—ã—Å–æ—Ç–∞)</span>
                        <span class="val-disp" id="rowVal">3</span>
                    </div>
                    <input type="range" id="rowRange" min="1" max="10" value="3">
                </div>

                <div class="control-group">
                    <div class="control-header">
                        <span>–ó–∞–∑–æ—Ä (Gap + –†–∞–º–∫–∞)</span>
                        <span class="val-disp" id="gapVal">0px</span>
                    </div>
                    <div class="control-row">
                        <input type="range" id="gapRange" min="-50" max="100" value="0">
                        <input type="color" id="gapColor" value="#000000" title="–¶–≤–µ—Ç —Ñ–æ–Ω–∞ –∑–∞–∑–æ—Ä–∞">
                    </div>
                    
                    <div class="control-header" style="margin-top:8px; border-top:1px solid #444; padding-top:8px;">
                        <span>–õ–∏–Ω–∏–∏ —Ä–µ–∑–∞ (–°—Ç–∏–ª—å –∏ –¢–æ–ª—â–∏–Ω–∞)</span>
                        <span class="val-disp" id="guideWidthVal">1px</span>
                    </div>
                    <div class="control-row">
                        <select id="guideStyle" style="width: 40%;">
                            <option value="none">–ë–µ–∑ –ª–∏–Ω–∏–π</option>
                            <option value="solid">–°–ø–ª–æ—à–Ω–∞—è</option>
                            <option value="dashed">–ü—É–Ω–∫—Ç–∏—Ä</option>
                            <option value="dotted">–¢–æ—á–∫–∏</option>
                        </select>
                        <input type="range" id="guideWidthRange" min="1" max="10" value="1" step="1" title="–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏">
                        <input type="color" id="guideColor" value="#999999" title="–¶–≤–µ—Ç –ª–∏–Ω–∏–π">
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-header">
                        <span>–í–Ω–µ—à–Ω–µ–µ –ø–æ–ª–µ (–†–∞–º–∫–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞)</span>
                        <span class="val-disp" id="padVal">0px</span>
                    </div>
                    <div class="control-row">
                        <input type="range" id="padRange" min="0" max="100" value="0">
                        <input type="color" id="padColor" value="#ffffff" title="–¶–≤–µ—Ç –ø–æ–ª—è">
                    </div>
                </div>

                <div class="control-group filter-group">
                    <div class="control-header">
                        <span>–Ø—Ä–∫–æ—Å—Ç—å</span>
                        <span class="val-disp" id="brightnessVal">100%</span>
                    </div>
                    <input type="range" id="brightnessRange" min="50" max="150" value="100">
                    
                    <div class="control-header" style="margin-top:10px;">
                        <span>–ö–æ–Ω—Ç—Ä–∞—Å—Ç</span>
                        <span class="val-disp" id="contrastVal">100%</span>
                    </div>
                    <input type="range" id="contrastRange" min="50" max="200" value="100">
                </div>

                <div class="control-group">
                    <div class="control-header">
                        <span>–ú–∞—Å—à—Ç–∞–± –≤–∏–¥–∞</span>
                        <span class="val-disp" id="scaleVal">60%</span>
                    </div>
                    <input type="range" id="scaleRange" min="0.2" max="1.5" step="0.1" value="0.6">
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px; margin-top:20px;">
                    <button class="btn" onclick="document.getElementById('fileInputCollage').click()">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                    </button>
                    <input type="file" id="fileInputCollage" multiple accept="image/*">
                    
                    <button class="btn btn-green" id="dlAllBtn" onclick="downloadAll()">
                        ‚¨á –°–∫–∞—á–∞—Ç—å –≤—Å–µ –ª–∏—Å—Ç—ã
                    </button>
                    <button class="btn btn-outline" onclick="clearCollage()">
                        üóë –û—á–∏—Å—Ç–∏—Ç—å –∫–æ–ª–ª–∞–∂
                    </button>
                    <button class="btn btn-outline btn-reset" onclick="resetSettings('collage')">
                        ‚Üª –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>
                
                <div style="font-size:12px; color:#666; text-align:center; margin-top:10px;">
                    –ö–∞—Ä—Ç–∏–Ω–æ–∫: <span id="imgCount">0</span> | –õ–∏—Å—Ç–æ–≤: <span id="sheetCount">0</span>
                </div>
            </div>

        </div>
    </div>

    <div class="main-area">
        <div class="drop-overlay" id="dropOverlay">
            <h2>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</h2>
        </div>
        
        <div id="view-slicer" class="view-container active">
            <div id="slicerEmpty" class="empty-msg">
                <h3>–í–∫–ª–∞–¥–∫–∞ "–†–∞–∑—Ä–µ–∑–∫–∞"</h3>
                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É</p>
            </div>
            <div class="view-content-wrapper" id="slicerWrapper">
                <div class="slicer-stage hidden" id="slicerStage">
                    <img id="sourceImage" class="source-img" src="" alt="Source">
                    <div id="slicerOverlay" class="slicer-overlay"></div>
                </div>
            </div>
        </div>

        <div id="view-collage" class="view-container">
            <div id="collageEmpty" class="empty-msg">
                <h3>–í–∫–ª–∞–¥–∫–∞ "–ö–æ–ª–ª–∞–∂"</h3>
                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å—é–¥–∞</p>
            </div>
            <div class="view-content-wrapper" id="collageWrapper"></div>
        </div>
    </div>

    <script>
        // --- DEFAULTS ---
        const DEFAULTS = {
            slicer: { cols: 2, rows: 2, scale: 1.0 },
            collage: { 
                cols: 3, rows: 3, 
                gap: 0, gapColor: '#000000',
                guideStyle: 'none', guideColor: '#999999', guideThickness: 1, 
                pad: 0, padColor: '#ffffff',
                scale: 0.6,
                brightness: 100,
                contrast: 100
            }
        };

        const store = {
            activeTab: 'slicer',
            baseFilename: 'collage',
            slicer: { img: null, ...DEFAULTS.slicer },
            collage: { images: [], ...DEFAULTS.collage }
        };

        const dom = {
            panels: { slicer: document.getElementById('panel-slicer'), collage: document.getElementById('panel-collage') },
            views: { slicer: document.getElementById('view-slicer'), collage: document.getElementById('view-collage') },
            tabs: document.querySelectorAll('.nav-tab'),
            dropOverlay: document.getElementById('dropOverlay'),
            
            // Slicer UI
            sFile: document.getElementById('fileInputSource'),
            sColRange: document.getElementById('sliceColRange'), sRowRange: document.getElementById('sliceRowRange'),
            sColVal: document.getElementById('sliceColVal'), sRowVal: document.getElementById('sliceRowVal'),
            sScaleRange: document.getElementById('slicerScaleRange'), sScaleVal: document.getElementById('slicerScaleVal'),
            btnSlice: document.getElementById('btnSlice'),
            sWrapper: document.getElementById('slicerWrapper'), sStage: document.getElementById('slicerStage'),
            sEmpty: document.getElementById('slicerEmpty'), sImg: document.getElementById('sourceImage'), sOverlay: document.getElementById('slicerOverlay'),

            // Collage UI
            cFile: document.getElementById('fileInputCollage'),
            cColRange: document.getElementById('colRange'), cRowRange: document.getElementById('rowRange'),
            cColVal: document.getElementById('colVal'), cRowVal: document.getElementById('rowVal'),
            
            // Gap & Guides
            cGapRange: document.getElementById('gapRange'), cGapVal: document.getElementById('gapVal'), cGapColor: document.getElementById('gapColor'),
            cGuideStyle: document.getElementById('guideStyle'), cGuideColor: document.getElementById('guideColor'),
            cGuideWidthRange: document.getElementById('guideWidthRange'), cGuideWidthVal: document.getElementById('guideWidthVal'),

            // Padding
            cPadRange: document.getElementById('padRange'), cPadVal: document.getElementById('padVal'), cPadColor: document.getElementById('padColor'),
            
            // Filters
            cBrightnessRange: document.getElementById('brightnessRange'), cBrightnessVal: document.getElementById('brightnessVal'),
            cContrastRange: document.getElementById('contrastRange'), cContrastVal: document.getElementById('contrastVal'),

            // Scale
            cScaleRange: document.getElementById('scaleRange'), cScaleVal: document.getElementById('scaleVal'),
            imgCount: document.getElementById('imgCount'), sheetCount: document.getElementById('sheetCount'),
            cWrapper: document.getElementById('collageWrapper'), cEmpty: document.getElementById('collageEmpty'),
            dlAllBtn: document.getElementById('dlAllBtn')
        };

        init();

        function init() {
            loadSettings();
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => document.body.addEventListener(e, preventDefaults, false));
            document.body.addEventListener('dragenter', () => dom.dropOverlay.classList.add('active'));
            document.body.addEventListener('dragleave', (e) => { if (!e.clientX && !e.clientY) dom.dropOverlay.classList.remove('active'); });
            document.body.addEventListener('drop', handleGlobalDrop);

            // Slicer Listeners
            dom.sFile.addEventListener('change', (e) => processSourceFile(e.target.files[0]));
            dom.sColRange.addEventListener('input', (e) => { store.slicer.cols = +e.target.value; updateSlicerUI(); });
            dom.sRowRange.addEventListener('input', (e) => { store.slicer.rows = +e.target.value; updateSlicerUI(); });
            dom.sScaleRange.addEventListener('input', (e) => { store.slicer.scale = +e.target.value; updateSlicerUI(); });

            // Collage Listeners
            dom.cFile.addEventListener('change', (e) => addCollageImages(e.target.files));
            dom.cColRange.addEventListener('input', (e) => { store.collage.cols = +e.target.value; updateCollageUI(); });
            dom.cRowRange.addEventListener('input', (e) => { store.collage.rows = +e.target.value; updateCollageUI(); });
            
            dom.cGapRange.addEventListener('input', (e) => { store.collage.gap = +e.target.value; updateCollageUI(); });
            dom.cGapColor.addEventListener('input', (e) => { store.collage.gapColor = e.target.value; updateCollageUI(); });
            
            dom.cGuideStyle.addEventListener('change', (e) => { store.collage.guideStyle = e.target.value; updateCollageUI(); });
            dom.cGuideColor.addEventListener('input', (e) => { store.collage.guideColor = e.target.value; updateCollageUI(); });
            dom.cGuideWidthRange.addEventListener('input', (e) => { store.collage.guideThickness = +e.target.value; updateCollageUI(); });

            dom.cPadRange.addEventListener('input', (e) => { store.collage.pad = +e.target.value; updateCollageUI(); });
            dom.cPadColor.addEventListener('input', (e) => { store.collage.padColor = e.target.value; updateCollageUI(); });

            // Filters Listeners
            dom.cBrightnessRange.addEventListener('input', (e) => { store.collage.brightness = +e.target.value; updateCollageUI(); });
            dom.cContrastRange.addEventListener('input', (e) => { store.collage.contrast = +e.target.value; updateCollageUI(); });

            dom.cScaleRange.addEventListener('input', (e) => { store.collage.scale = +e.target.value; updateCollageUI(); });
        }

        // --- SAVING & LOADING ---
        function saveSettings() {
            const settings = {
                slicer: { cols: store.slicer.cols, rows: store.slicer.rows, scale: store.slicer.scale },
                collage: {
                    cols: store.collage.cols, rows: store.collage.rows,
                    gap: store.collage.gap, gapColor: store.collage.gapColor,
                    guideStyle: store.collage.guideStyle, guideColor: store.collage.guideColor,
                    guideThickness: store.collage.guideThickness, 
                    pad: store.collage.pad, padColor: store.collage.padColor,
                    scale: store.collage.scale,
                    brightness: store.collage.brightness, 
                    contrast: store.collage.contrast      
                }
            };
            localStorage.setItem('gridMasterSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('gridMasterSettings');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if(parsed.slicer) Object.assign(store.slicer, parsed.slicer);
                    if(parsed.collage) Object.assign(store.collage, parsed.collage);
                } catch(e) { console.error(e); }
            }
            syncDOM();
        }

        window.resetSettings = function(type) {
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏?")) {
                if (type === 'slicer') Object.assign(store.slicer, DEFAULTS.slicer);
                if (type === 'collage') Object.assign(store.collage, DEFAULTS.collage);
                syncDOM();
                saveSettings();
                if (type === 'slicer' && store.slicer.img) updateSlicerGrid();
                if (type === 'collage') { renderCollage(); updateCollageStyles(); }
            }
        };

        function syncDOM() {
            dom.sColRange.value = store.slicer.cols; dom.sRowRange.value = store.slicer.rows;
            dom.sScaleRange.value = store.slicer.scale;
            updateSlicerUI(false);

            dom.cColRange.value = store.collage.cols; dom.cRowRange.value = store.collage.rows;
            dom.cGapRange.value = store.collage.gap; dom.cGapColor.value = store.collage.gapColor;
            dom.cGuideStyle.value = store.collage.guideStyle; dom.cGuideColor.value = store.collage.guideColor;
            dom.cGuideWidthRange.value = store.collage.guideThickness; 

            dom.cPadRange.value = store.collage.pad; dom.cPadColor.value = store.collage.padColor;
            dom.cBrightnessRange.value = store.collage.brightness;
            dom.cContrastRange.value = store.collage.contrast;
            dom.cScaleRange.value = store.collage.scale;
            updateCollageUI(false);
        }

        function updateSlicerUI(shouldSave = true) {
            dom.sColVal.innerText = store.slicer.cols; 
            dom.sRowVal.innerText = store.slicer.rows;
            dom.sScaleVal.innerText = Math.round(store.slicer.scale * 100) + '%';
            dom.sWrapper.style.transform = `scale(${store.slicer.scale})`;
            updateSlicerGrid();
            if(shouldSave) saveSettings();
        }

        function updateCollageUI(shouldSave = true) {
            dom.cColVal.innerText = store.collage.cols; 
            dom.cRowVal.innerText = store.collage.rows;
            dom.cGapVal.innerText = store.collage.gap + 'px';
            dom.cPadVal.innerText = store.collage.pad + 'px';
            dom.cGuideWidthVal.innerText = store.collage.guideThickness + 'px'; 
            dom.cBrightnessVal.innerText = store.collage.brightness + '%';
            dom.cContrastVal.innerText = store.collage.contrast + '%';
            dom.cScaleVal.innerText = Math.round(store.collage.scale * 100) + '%';
            dom.cWrapper.style.transform = `scale(${store.collage.scale})`;
            
            if(store.collage.images.length > 0) renderCollage();
            else updateCollageStyles();
            
            if(shouldSave) saveSettings();
        }

        // --- CORE LOGIC ---
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        function handleGlobalDrop(e) {
            dom.dropOverlay.classList.remove('active');
            const files = e.dataTransfer.files;
            if (store.activeTab === 'slicer') { if (files.length > 0) processSourceFile(files[0]); }
            else { addCollageImages(files); }
        }

        window.switchTab = function(tabName) {
            store.activeTab = tabName;
            dom.tabs.forEach((t, i) => t.classList.toggle('active', (tabName === 'slicer' && i === 0) || (tabName === 'collage' && i === 1)));
            dom.panels.slicer.classList.toggle('active', tabName === 'slicer');
            dom.panels.collage.classList.toggle('active', tabName === 'collage');
            dom.views.slicer.classList.toggle('active', tabName === 'slicer');
            dom.views.collage.classList.toggle('active', tabName === 'collage');
        };

        function processSourceFile(file) {
            if (!file || !file.type.startsWith('image/')) return;
            store.baseFilename = file.name.replace(/\.[^/.]+$/, "");
            const reader = new FileReader();
            reader.onload = (ev) => {
                dom.sImg.src = ev.target.result;
                dom.sImg.onload = () => {
                    store.slicer.img = dom.sImg;
                    dom.sEmpty.classList.add('hidden');
                    dom.sStage.classList.remove('hidden');
                    dom.btnSlice.disabled = false;
                    updateSlicerGrid();
                };
            };
            reader.readAsDataURL(file);
        }

        function updateSlicerGrid() {
            const c = store.slicer.cols, r = store.slicer.rows;
            dom.sOverlay.style.gridTemplateColumns = `repeat(${c}, 1fr)`;
            dom.sOverlay.style.gridTemplateRows = `repeat(${r}, 1fr)`;
            dom.sOverlay.innerHTML = '';
            for(let i=0; i<c*r; i++) {
                const cell = document.createElement('div'); cell.className = 'slicer-cell';
                dom.sOverlay.appendChild(cell);
            }
        }

        window.processSlicing = function() {
            if (!store.slicer.img) return;
            const btnOrig = dom.btnSlice.innerText; dom.btnSlice.innerText = "‚úÇ –û–±—Ä–∞–±–æ—Ç–∫–∞..."; dom.btnSlice.disabled = true;
            setTimeout(() => {
                const img = store.slicer.img, cols = store.slicer.cols, rows = store.slicer.rows;
                const cellW = img.naturalWidth / cols, cellH = img.naturalHeight / rows;
                const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
                canvas.width = cellW; canvas.height = cellH;
                const newImages = [];
                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        ctx.clearRect(0,0, cellW, cellH);
                        ctx.drawImage(img, x * cellW, y * cellH, cellW, cellH, 0, 0, cellW, cellH);
                        newImages.push(canvas.toDataURL('image/jpeg', 0.95));
                    }
                }
                store.collage.images = [...store.collage.images, ...newImages];
                dom.btnSlice.innerText = btnOrig; dom.btnSlice.disabled = false;
                renderCollage(); switchTab('collage');
            }, 50);
        };

        function addCollageImages(files) {
            const arr = Array.from(files);
            if(arr.length === 0) return;
            if (store.collage.images.length === 0 && arr.length > 0) {
                 store.baseFilename = arr[0].name.replace(/\.[^/.]+$/, "");
            }
            let loaded = 0;
            arr.forEach(f => {
                if(!f.type.startsWith('image/')) return;
                const r = new FileReader();
                r.onload = (e) => {
                    store.collage.images.push(e.target.result);
                    loaded++;
                    if(loaded === arr.length) updateCollageUI();
                };
                r.readAsDataURL(f);
            });
        }

        function renderCollage() {
            dom.cWrapper.innerHTML = '';
            const imgs = store.collage.images;
            dom.imgCount.innerText = imgs.length;
            if (imgs.length === 0) {
                dom.cEmpty.classList.remove('hidden'); dom.dlAllBtn.disabled = true; return;
            }
            dom.cEmpty.classList.add('hidden'); dom.dlAllBtn.disabled = false;
            
            const itemsPerSheet = store.collage.cols * store.collage.rows;
            const totalSheets = Math.ceil(imgs.length / itemsPerSheet);
            dom.sheetCount.innerText = totalSheets;

            for (let i = 0; i < totalSheets; i++) {
                const chunk = imgs.slice(i * itemsPerSheet, (i + 1) * itemsPerSheet);
                createSheet(chunk, i + 1);
            }
            updateCollageStyles();
        }

        function createSheet(images, index) {
            const card = document.createElement('div'); card.className = 'sheet-card';
            const header = document.createElement('div'); header.className = 'sheet-header';
            header.innerHTML = `<span>–õ–∏—Å—Ç ${index}</span><span>${images.length} —Ñ–æ—Ç–æ</span>`;

            const frame = document.createElement('div');
            frame.className = 'sheet-frame';

            const grid = document.createElement('div');
            grid.className = 'sheet-grid';
            grid.style.gridTemplateColumns = `repeat(${store.collage.cols}, 1fr)`;

            images.forEach(src => {
                const wrapper = document.createElement('div');
                wrapper.className = 'grid-wrapper';

                const img = document.createElement('img');
                img.className = 'grid-item';
                img.src = src;

                const guide = document.createElement('div');
                guide.className = 'guide-overlay';
                
                wrapper.appendChild(img);
                wrapper.appendChild(guide);
                grid.appendChild(wrapper);
            });

            const btn = document.createElement('button');
            btn.className = 'sheet-btn';
            btn.innerText = '–°–∫–∞—á–∞—Ç—å JPG (Full Res)';
            const filename = `${store.baseFilename}_sheet_${index}`;
            btn.onclick = () => downloadSheet(frame, filename);

            frame.appendChild(grid);
            card.appendChild(header);
            card.appendChild(frame);
            card.appendChild(btn);
            dom.cWrapper.appendChild(card);
        }

        function updateCollageStyles() {
            const grids = document.querySelectorAll('.sheet-grid');
            const frames = document.querySelectorAll('.sheet-frame');
            const wrappers = document.querySelectorAll('.grid-wrapper');
            const guides = document.querySelectorAll('.guide-overlay');
            
            let nativeGap = store.collage.gap + 'px';

            grids.forEach(g => {
                g.style.setProperty('--native-gap', nativeGap);
                g.style.setProperty('--gap-color', store.collage.gapColor);
            });
            
            guides.forEach(guide => {
                guide.style.setProperty('--guide-style', store.collage.guideStyle); 
                guide.style.setProperty('--guide-color', store.collage.guideColor);
                guide.style.setProperty('--guide-width-px', store.collage.guideThickness + 'px'); 
            });

            frames.forEach(f => {
                f.style.setProperty('--pad-px', store.collage.pad + 'px');
                f.style.setProperty('--pad-color', store.collage.padColor);
            });
        }

        window.clearCollage = function() {
            store.collage.images = []; 
            store.baseFilename = 'collage';
            renderCollage(); dom.cFile.value = '';
        }
        
        // --- –¶–≤–µ—Ç–æ–≤–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è (HSB/HSV) ---
        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, v = max;
            let d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) { h = 0; } 
            else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h, s: s, v: v };
        }

        function hsvToRgb(h, s, v) {
            let r, g, b;
            let i = Math.floor(h * 6);
            let f = h * 6 - i;
            let p = v * (1 - s);
            let q = v * (1 - f * s);
            let t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case 0: r = v; g = t; b = p; break;
                case 1: r = q; g = v; b = p; break;
                case 2: r = p; g = v; b = t; break;
                case 3: r = p; g = q; b = v; break;
                case 4: r = t; g = p; b = v; break;
                case 5: r = v; g = p; b = q; break;
            }
            return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
        }
        
        function applyImageAdjustments(imageData, brightness, contrast) {
            const data = imageData.data;
            const factorB = brightness / 100;
            const factorC = contrast / 100;
            const interceptC = 128 * (1 - factorC);

            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i + 1], b = data[i + 2];

                if (factorB !== 1) {
                    let hsv = rgbToHsv(r, g, b);
                    hsv.v = Math.min(1, Math.max(0, hsv.v * factorB)); 
                    let rgb = hsvToRgb(hsv.h, hsv.s, hsv.v);
                    r = rgb.r; g = rgb.g; b = rgb.b;
                }
                
                if (factorC !== 1) {
                    r = r * factorC + interceptC;
                    g = g * factorC + interceptC;
                    b = b * factorC + interceptC;
                }

                data[i]     = Math.min(255, Math.max(0, r));
                data[i + 1] = Math.min(255, Math.max(0, g));
                data[i + 2] = Math.min(255, Math.max(0, b));
            }
            return imageData;
        }

// --- –§–£–ù–ö–¶–ò–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —à—Ç—Ä–∏—Ö–∏ –ø—É–Ω–∫—Ç–∏—Ä–∞) ---
        async function downloadSheet(frameElement, name) {
            const prevTransform = dom.cWrapper.style.transform;
            dom.cWrapper.style.transform = 'scale(1)'; 
            await new Promise(r => setTimeout(r, 50));
            
            const { 
                cols, rows, gap, pad, 
                gapColor, padColor, 
                guideStyle, guideColor, guideThickness,
                brightness, contrast 
            } = store.collage;

            const gridItems = frameElement.querySelectorAll('.grid-item');
            if (gridItems.length === 0) return;

            // 1. –ò—Å—Ö–æ–¥–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            const firstImg = new Image();
            firstImg.crossOrigin = 'Anonymous';
            firstImg.src = gridItems[0].src;
            await new Promise(resolve => { firstImg.onload = resolve; firstImg.onerror = () => resolve(); });
            
            const nW = firstImg.naturalWidth;
            const nH = firstImg.naturalHeight;

            if (nW === 0 || nH === 0) {
                 alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
                 dom.cWrapper.style.transform = prevTransform;
                 return;
            }

            // 2. –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤ Canvas
            const totalW = (nW * cols) + (gap * (cols + 1)) + (pad * 2);
            const totalH = (nH * rows) + (gap * (rows + 1)) + (pad * 2);

            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = totalW;
            finalCanvas.height = totalH;
            const finalCtx = finalCanvas.getContext('2d');

            // 3. –ó–∞–ª–∏–≤–∫–∞ —Ñ–æ–Ω–∞ (Padding)
            finalCtx.fillStyle = padColor;
            finalCtx.fillRect(0, 0, totalW, totalH);
            
            // 4. –ó–∞–ª–∏–≤–∫–∞ –∑–æ–Ω—ã Gap (Gap Color)
            finalCtx.fillStyle = gapColor;
            finalCtx.fillRect(pad, pad, totalW - (pad * 2), totalH - (pad * 2));

            // 5. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            for (let i = 0; i < gridItems.length; i++) {
                const item = gridItems[i];
                const img = new Image();
                img.crossOrigin = 'Anonymous'; img.src = item.src;
                await new Promise(resolve => { img.onload = resolve; img.onerror = () => resolve(); });
                
                if (img.width > 0) {
                    const col = i % cols;
                    const row = Math.floor(i / cols);

                    const targetX = pad + (gap * (col + 1)) + (nW * col);
                    const targetY = pad + (gap * (row + 1)) + (nH * row);

                    const imgCanvas = document.createElement('canvas');
                    imgCanvas.width = nW; imgCanvas.height = nH;
                    const imgCtx = imgCanvas.getContext('2d');
                    imgCtx.drawImage(img, 0, 0, nW, nH);
                    
                    if (brightness !== 100 || contrast !== 100) {
                        let imageData = imgCtx.getImageData(0, 0, nW, nH);
                        imageData = applyImageAdjustments(imageData, brightness, contrast);
                        imgCtx.putImageData(imageData, 0, 0); 
                    }

                    finalCtx.drawImage(imgCanvas, targetX, targetY, nW, nH);
                }
            }
            
            // 6. –õ–∏–Ω–∏–∏ —Ä–µ–∑–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
            if (guideStyle !== 'none') { 
                finalCtx.strokeStyle = guideColor;
                finalCtx.lineWidth = guideThickness;
                finalCtx.lineCap = 'butt'; // –î–µ–ª–∞–µ—Ç –∫–æ–Ω—Ü—ã —à—Ç—Ä–∏—Ö–æ–≤ –ø–ª–æ—Å–∫–∏–º–∏ (–∫–∞–∫ –≤ CSS)
                
                const styleMap = {
                    'solid': [],
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: 3x —Ç–æ–ª—â–∏–Ω–∞ - —à—Ç—Ä–∏—Ö, 3x —Ç–æ–ª—â–∏–Ω–∞ - –ø—Ä–æ–±–µ–ª (–°—Ç–∞–Ω–¥–∞—Ä—Ç CSS)
                    'dashed': [3 * guideThickness, 3 * guideThickness], 
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: 1x —Ç–æ–ª—â–∏–Ω–∞ - —Ç–æ—á–∫–∞, 1x —Ç–æ–ª—â–∏–Ω–∞ - –ø—Ä–æ–±–µ–ª
                    'dotted': [guideThickness, guideThickness]
                };
                finalCtx.setLineDash(styleMap[guideStyle] || []);

                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ
                for (let j = 0; j <= cols; j++) {
                    const lineX = pad + (gap * j) + (gap / 2) + (nW * j);
                    finalCtx.beginPath();
                    finalCtx.moveTo(lineX, pad + (gap / 2)); 
                    finalCtx.lineTo(lineX, totalH - pad - (gap / 2)); 
                    finalCtx.stroke();
                }

                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ
                for (let i = 0; i <= rows; i++) {
                    const lineY = pad + (gap * i) + (gap / 2) + (nH * i);
                    finalCtx.beginPath();
                    finalCtx.moveTo(pad + (gap / 2), lineY);
                    finalCtx.lineTo(totalW - pad - (gap / 2), lineY);
                    finalCtx.stroke();
                }
                finalCtx.setLineDash([]); 
            }
            
            // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
            const link = document.createElement('a');
            link.download = name + '.jpg';
            link.href = finalCanvas.toDataURL('image/jpeg', 0.95);
            link.click();

            dom.cWrapper.style.transform = prevTransform; 
        }
        window.downloadAll = async function() {
            const frames = document.querySelectorAll('.sheet-frame');
            if(frames.length === 0) return;
            const btn = dom.dlAllBtn; const txt = btn.innerText;
            btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..."; btn.disabled = true;
            for(let i=0; i<frames.length; i++) {
                await new Promise(r=>setTimeout(r, 400)); 
                const filename = `${store.baseFilename}_sheet_${i+1}`;
                await downloadSheet(frames[i], filename);
            }
            btn.innerText = txt; btn.disabled = false;
        }
    </script>
</body>
</html>
